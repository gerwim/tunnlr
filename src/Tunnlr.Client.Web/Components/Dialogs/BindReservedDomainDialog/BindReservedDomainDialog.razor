@using Tunnlr.Client.Core.Models
@using Tunnlr.Client.Web.Persistence
@using Microsoft.EntityFrameworkCore
@namespace Tunnlr.Client.Web.Components.Dialogs.BindReservedDomainDialog
@inject TunnlrDbContext DbContext

<MudDialog>
    <DialogContent>
        Bind @ReservedDomain.Domain to
        <MudSelect Dense="true" T="Guid" Label="Tunnel" @bind-Value="SelectedTunnel" Variant="Variant.Text">
            <MudSelectItem Value="@(Guid.Empty)">none</MudSelectItem>
            @foreach (var dbContextTunnel in DbContext.Tunnels.Include(x => x.ReservedDomain).Where(x => x.Id == SelectedTunnel || x.ReservedDomain == null))
            {
                <MudSelectItem Value="@(dbContextTunnel.Id)">@dbContextTunnel.TargetUri</MudSelectItem>
            }
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">Ok</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public required ReservedDomain ReservedDomain { get; set; }
    private Guid SelectedTunnel { get; set; } = Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        var reservedDomain = await DbContext.ReservedDomains.FirstOrDefaultAsync(x => x.Domain == ReservedDomain.Domain);
        if (reservedDomain?.TunnelId is not null ) SelectedTunnel = reservedDomain.TunnelId.Value;
    }

    void Submit()
    {
        var reservedDomain = DbContext.ReservedDomains.AsTracking().FirstOrDefault(x => x.Domain == ReservedDomain.Domain);
        if (reservedDomain is not null)
        {
            reservedDomain.TunnelId = SelectedTunnel == Guid.Empty ? null : SelectedTunnel;
            DbContext.SaveChanges();
        }

        MudDialog.Close(DialogResult.Ok(true));
    }

    void Cancel() => MudDialog.Cancel();
}